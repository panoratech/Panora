# run directly from the repo root directory

# docker build -f ./apps/client-vite/Dockerfile.dev . \
#   --build-arg VITE_STYTCH_PROJECT_ID=test \
#   --build-arg VITE_STYTCH_SECRET=value2 \
#   --build-arg VITE_STYTCH_PROJECT_ENV=value3 \
#   --build-arg VITE_STYTCH_PUBLIC_TOKEN=value4 \
#   --build-arg VITE_DISTRIBUTION=selfhosted \
#   --build-arg VITE_BACKEND_DOMAIN=http://localhost:3000 \
#   --build-arg VITE_MAGIC_LINK_DOMAIN=http://localhost:81 \
#   --build-arg VITE_WEBAPP_DOMAIN=http://localhost


FROM node:20-alpine AS base
# =======================================================================
FROM base AS builder
RUN apk add --no-cache libc6-compat
RUN apk update

# Set pnpm
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

ARG VITE_STYTCH_PROJECT_ID
ARG VITE_STYTCH_SECRET
ARG VITE_STYTCH_PROJECT_ENV
ARG VITE_STYTCH_PUBLIC_TOKEN
ARG VITE_DISTRIBUTION 
ARG VITE_BACKEND_DOMAIN
ARG VITE_MAGIC_LINK_DOMAIN
ARG VITE_WEBAPP_DOMAIN

ENV VITE_STYTCH_PROJECT_ID="$VITE_STYTCH_PROJECT_ID"
ENV VITE_STYTCH_SECRET="$VITE_STYTCH_SECRET"
ENV VITE_STYTCH_PROJECT_ENV="$VITE_STYTCH_PROJECT_ENV"
ENV VITE_STYTCH_PUBLIC_TOKEN="$VITE_STYTCH_PUBLIC_TOKEN"

ENV VITE_DISTRIBUTION="$VITE_DISTRIBUTION"
ENV VITE_BACKEND_DOMAIN="${VITE_BACKEND_DOMAIN}"
ENV VITE_MAGIC_LINK_DOMAIN="${VITE_MAGIC_LINK_DOMAIN}"
ENV VITE_WEBAPP_DOMAIN="${VITE_WEBAPP_DOMAIN}"

RUN corepack enable


WORKDIR /app
RUN pnpm add -g turbo

#WORKDIR /app/apps/client-vite
# run the ML
CMD cd apps/client-vite && pnpm install && pnpm run dev --host